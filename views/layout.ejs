<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://bootswatch.com/4/slate/bootstrap.min.css">
    <link rel="stylesheet" href="/css/notis.css">
    <title>Tolfx Stats</title>
</head>
<body class="text-white">
    <%- include('./partials/messages') %> 

    <% if (general.isAuth) { %>

      <% if (general.notis.length > 0) { %>
        <% general.notis.forEach(notis => { %>
          <% if (notis.active) { %>
          <div class="notis" id="<%= notis._id %>">
            <div class="notisHeader" id="<%= notis._id %>Header"><%= notis.name %> 
              <button class="float-right btn-sm align-middle" id="close<%= notis._id %>">+</button>
              <a class="float-right btn bg-warning text-white btn-sm align-middle" href="/notis/edit/<%= notis._id %>">Edit</a>
            </div>
            <div id="boxNotis" class="boxNotis<%= notis._id %>" style="color: black;">
              <%- notis.informationSani %> 
            </div>
          </div>

          <script>
                let boxNotis = document.querySelector(".boxNotis<%= notis._id %>");
                <% if (notis.closed) { %>
                  boxNotis.style.display = "none";
                <% } else { %>
                  boxNotis.style.display = "block";
                <% } %>
            $("#close<%= notis._id %>").click(function(){
                if($(this).html() == "-"){
                    $(this).html("+");
                }
                else{
                    $(this).html("-");
                }

                if (boxNotis.style.display === "block") {
                  boxNotis.style.display = "none";
                  fetch("/notis/save/<%= notis._id %>/closed/true", {method: "POST"});
                } else {
                  fetch("/notis/save/<%= notis._id %>/closed/false", {method: "POST"});
                  boxNotis.style.display = "block";
                }
            });


            function dragElement(elmnt, pos1, pos2) {
              let pos3 = 0, pos4 = 0;
              elmnt.style.top = (pos2) + "px";
              elmnt.style.left = (pos1) + "px";
              if (document.getElementById(elmnt.id + "Header")) {
                /* if present, the header is where you move the DIV from:*/
                document.getElementById(elmnt.id + "Header").onmousedown = dragMouseDown;
              } else {
                /* otherwise, move the DIV from anywhere inside the DIV:*/
                elmnt.onmousedown = dragMouseDown;
              }

              function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // call a function whenever the cursor moves:
                document.onmousemove = elementDrag;
              }

              function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // calculate the new cursor position:
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // set the element's new position:
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
              }

              function closeDragElement() {
                /* stop moving when mouse button is released:*/
                fetch("/notis/save/<%= notis._id %>/pos/"+(elmnt.offsetLeft - pos1)+"/"+(elmnt.offsetTop - pos2), { method: "POST"});
                document.onmouseup = null;
                document.onmousemove = null;
              }
            }
            dragElement(document.getElementById("<%= notis._id %>"), "<%= notis.posX %>", "<%= notis.posY %>")
          </script>
          <% } %>
        <% }) %>
      <% } %>

        <div class="container mt-3">
            <nav class="navbar navbar-expand-lg rounded shadow">
                <a class="navbar-brand" href="/">Tolfx Stats</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                  <ul class="navbar-nav">
                    <li class="nav-item">
                      <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Tables
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <% general.tables.forEach(t => { %>
                                <a href="/table/view/<%= t._id %>" class="dropdown-item"><%= t.tableName %></a>
                            <% }) %>
                        </div>
                    </li>
                  </ul>
                </div>
              </nav>
        </div>
    <% } %>


    <div>
        <%- body %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
</body>
</html>